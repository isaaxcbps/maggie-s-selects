<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario | Maggie's Selects</title>
    <style>
        :root { --primary: #1a1a1a; --accent: #d4af37; --bg: #f4f4f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        h2 { text-transform: uppercase; letter-spacing: 1px; text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        .btn-add { background: var(--primary); color: white; font-weight: bold; cursor: pointer; border: none; }
        .btn-add:hover { background: #333; }
        
        /* Tabla de Inventario */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #f8f8f8; }
        .btn-edit { background: #2196F3; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; margin-right: 5px; }
        .btn-delete { background: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        img { width: 40px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 id="titulo-form">Agregar Nuevo Producto</h2>
        <form id="prod-form">
            <input type="hidden" id="prod-id">
            <div class="form-grid">
                <div class="form-group full-width"><label>Nombre</label><input type="text" id="nombre" required></div>
                <div class="form-group"><label>Marca</label><input type="text" id="marca" required></div>
                <div class="form-group"><label>CategorÃ­a</label>
                    <select id="categoria"><option value="carteras">Carteras</option><option value="perfumes">Perfumes</option></select>
                </div>
                <div class="form-group"><label>Precio ($)</label><input type="number" id="precio" step="0.01" required></div>
                <div class="form-group"><label>Stock</label><input type="number" id="stock" required></div>
                <div class="form-group full-width" id="foto-container"><label>Foto</label><input type="file" id="fotoInput" accept="image/*"></div>
            </div>
            <button type="submit" class="btn-add" id="btn-main">Guardar Producto</button>
            <button type="button" id="btn-cancelar" style="display:none; background:#ccc; margin-top:10px; border:none; cursor:pointer;">Cancelar EdiciÃ³n</button>
        </form>
    </div>

    <div class="card">
        <h2>Inventario Actual</h2>
        <table id="tabla-productos">
            <thead><tr><th>Foto</th><th>Producto</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr></thead>
            <tbody id="lista-items"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = 'https://api-maggies.nauc8778.workers.dev';
    let editMode = false;

    // --- CARGAR PRODUCTOS (READ) ---
    async function cargarTabla() {
        const res = await fetch(API_URL);
        const data = await res.json();
        const body = document.getElementById('lista-items');
        body.innerHTML = '';
        data.forEach(p => {
            body.innerHTML += `
                <tr>
                    <td><img src="${p.imagen}"></td>
                    <td><strong>${p.marca}</strong><br>${p.nombre}</td>
                    <td>$${p.precio.toFixed(2)}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button class="btn-edit" onclick="prepararEdicion(${p.id}, '${p.nombre}', '${p.marca}', ${p.precio}, ${p.stock})">âœŽ</button>
                        <button class="btn-delete" onclick="eliminarProducto(${p.id})">ðŸ—‘</button>
                    </td>
                </tr>`;
        });
    }

    // --- ELIMINAR (DELETE) ---
    async function eliminarProducto(id) {
        if (!confirm("Â¿Seguro que deseas eliminar este producto?")) return;
        await fetch(API_URL, { method: 'DELETE', body: JSON.stringify({ id }) });
        cargarTabla();
    }

    // --- PREPARAR EDICIÃ“N (UPDATE) ---
    function prepararEdicion(id, nombre, marca, precio, stock) {
        editMode = true;
        document.getElementById('prod-id').value = id;
        document.getElementById('nombre').value = nombre;
        document.getElementById('marca').value = marca;
        document.getElementById('precio').value = precio;
        document.getElementById('stock').value = stock;
        document.getElementById('foto-container').style.display = 'none'; // No editamos foto por ahora
        document.getElementById('btn-main').innerText = "Actualizar Datos";
        document.getElementById('btn-cancelar').style.display = 'block';
        document.getElementById('titulo-form').innerText = "Editando Producto";
    }

    document.getElementById('btn-cancelar').onclick = () => location.reload();

    // --- GUARDAR O ACTUALIZAR (CREATE / UPDATE) ---
    document.getElementById('prod-form').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('prod-id').value;
        const datos = {
            nombre: document.getElementById('nombre').value,
            marca: document.getElementById('marca').value,
            precio: parseFloat(document.getElementById('precio').value),
            stock: parseInt(document.getElementById('stock').value)
        };

        if (editMode) {
            await fetch(API_URL, { method: 'PUT', body: JSON.stringify({ id, ...datos }) });
        } else {
            const file = document.getElementById('fotoInput').files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const fullData = { 
                    ...datos, 
                    categoria: document.getElementById('categoria').value,
                    imagenNombre: file.name.replace(/\s+/g, '-').toLowerCase(),
                    imagenBase64: reader.result.split(',')[1]
                };
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(fullData) });
                location.reload();
            };
            return;
        }
        location.reload();
    };

    cargarTabla();
</script>
</body>
</html>
