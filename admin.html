<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo | Maggie's Selects</title>
    <style>
        :root { 
            --primary: #1a1a1a; 
            --accent: #d4af37; 
            --bg: #f9f9f9; 
            --white: #ffffff; 
            --error: #f44336;
            --success: #2e7d32;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; min-height: 100vh; }
        
        /* Men√∫ Lateral */
        .sidebar { width: 260px; background: var(--primary); color: white; position: fixed; height: 100%; padding: 25px; box-sizing: border-box; z-index: 100; }
        .sidebar h2 { font-size: 1.1rem; color: var(--accent); text-align: center; margin-bottom: 35px; border-bottom: 1px solid #333; padding-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
        .nav-btn { width: 100%; padding: 14px; background: none; border: none; color: #aaa; text-align: left; cursor: pointer; font-size: 0.95rem; transition: 0.3s; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover, .nav-btn.active { background: #262626; color: white; }
        .nav-btn.active { border-left: 4px solid var(--accent); }

        /* √Årea de Contenido */
        .main-content { margin-left: 260px; padding: 40px; width: calc(100% - 260px); box-sizing: border-box; }
        .section { display: none; background: var(--white); padding: 35px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .section.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Formularios */
        h1 { margin-top: 0; font-weight: 300; text-transform: uppercase; letter-spacing: 1px; font-size: 1.5rem; color: var(--primary); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 700px; margin-top: 25px; }
        .full { grid-column: span 2; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 0.95rem; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }
        
        .btn-save { background: var(--primary); color: white; border: none; padding: 16px; cursor: pointer; border-radius: 8px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-save:hover { background: #333; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* Tablas */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fcfcfc; text-transform: uppercase; font-size: 0.75rem; color: #888; letter-spacing: 1px; }
        td { font-size: 0.9rem; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: capitalize; }
        .badge-cat { background: #f0f0f0; color: #555; }
        
        .actions { display: flex; gap: 15px; }
        .btn-action { cursor: pointer; background: none; border: none; font-size: 1.1rem; transition: 0.2s; padding: 5px; }
        .btn-edit { color: #2196F3; }
        .btn-delete { color: var(--error); }
        .btn-action:hover { transform: scale(1.2); }
        
        #status-msg { margin-top: 25px; padding: 15px; border-radius: 8px; display: none; text-align: center; font-weight: bold; font-size: 0.9rem; }

        /* Responsivo */
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 15px 5px; }
            .sidebar h2, .nav-btn span { display: none; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .full { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Maggie's</h2>
        <button class="nav-btn active" onclick="showSection('sec-ver', this)">
            <span>üìä Inventario</span>
        </button>
        <button class="nav-btn" onclick="showSection('sec-add', this)">
            <span>‚ûï A√±adir Producto</span>
        </button>
        <button class="nav-btn" onclick="logout()" style="margin-top: 50px; color: #ff5252;">
            <span>üîí Cerrar Sesi√≥n</span>
        </button>
    </div>

    <div class="main-content">
        <div id="sec-ver" class="section active">
            <h1>Inventario General</h1>
            <p style="color: #666; margin-bottom: 30px;">Visualiza y gestiona todos los art√≠culos de lujo disponibles en la tienda.</p>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Producto / Marca</th>
                            <th>Categor√≠a</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-tabla">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="sec-add" class="section">
            <h1 id="form-title">A√±adir Nuevo Art√≠culo</h1>
            <p id="form-desc" style="color: #666;">Completa los detalles para publicar el producto.</p>
            
            <form id="main-form">
                <input type="hidden" id="prod-id">
                <div class="form-grid">
                    <div class="form-group full">
                        <label>Nombre del Producto</label>
                        <input type="text" id="nombre" required placeholder="Ej: Bolso Tote Cuero Negro">
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="marca" required placeholder="Ej: Carolina Herrera">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="categoria">
                            <option value="carteras">Carteras y Bolsos</option>
                            <option value="perfumes">Perfumes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio de Venta ($)</label>
                        <input type="number" id="precio" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Stock Disponible</label>
                        <input type="number" id="stock" min="0" required placeholder="1">
                    </div>
                    
                    <div class="form-group full" id="group-foto">
                        <label>Imagen del Producto</label>
                        <input type="file" id="fotoInput" accept="image/*">
                        <small style="color: #999; display: block; margin-top: 5px;">Selecciona una foto n√≠tida del producto.</small>
                    </div>

                    <div class="form-group full" style="margin-top: 10px;">
                        <button type="submit" class="btn-save" id="btn-submit">Publicar en Tienda</button>
                        <button type="button" onclick="cancelarEdicion()" id="btn-cancel" style="display:none; background:#eee; color: #333; margin-top:12px;" class="btn-save">Cancelar Edici√≥n</button>
                    </div>
                </div>
            </form>
            <div id="status-msg"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://api-maggies.nauc8778.workers.dev';
        let isEditing = false;

        // --- SISTEMA DE AUTENTICACI√ìN ---
        let adminPass = sessionStorage.getItem('maggie_auth');
        
        async function checkAuth() {
            if (!adminPass) {
                adminPass = prompt("üîê Ingrese la clave de administrador para Maggie's Selects:");
                if (!adminPass) {
                    document.body.innerHTML = "<h1 style='padding:50px; text-align:center;'>Acceso denegado. Recargue la p√°gina.</h1>";
                    return;
                }
                sessionStorage.setItem('maggie_auth', adminPass);
            }
            cargarInventario();
        }

        function logout() {
            sessionStorage.removeItem('maggie_auth');
            location.reload();
        }

        // --- NAVEGACI√ìN ---
        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            
            if(id === 'sec-ver') {
                cancelarEdicion(); // Resetear form si se cambia de pesta√±a
                cargarInventario();
            }
        }

        // --- MOSTRAR (READ) ---
        async function cargarInventario() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const body = document.getElementById('lista-tabla');
                body.innerHTML = '';
                
                if(data.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay productos registrados.</td></tr>';
                    return;
                }

                data.forEach(p => {
                    body.innerHTML += `
                        <tr>
                            <td><strong>${p.marca}</strong><br><span style="color:#777;">${p.nombre}</span></td>
                            <td><span class="badge badge-cat">${p.categoria}</span></td>
                            <td><strong>$${p.precio.toFixed(2)}</strong></td>
                            <td>${p.stock} un.</td>
                            <td class="actions">
                                <button class="btn-action btn-edit" title="Editar" onclick="iniciarEdicion(${p.id}, '${p.nombre}', '${p.marca}', ${p.precio}, ${p.stock})">‚úé</button>
                                <button class="btn-action btn-delete" title="Eliminar" onclick="borrarProducto(${p.id})">üóë</button>
                            </td>
                        </tr>`;
                });
            } catch (err) {
                console.error("Error cargando inventario");
            }
        }

        // --- ELIMINAR (DELETE) ---
        async function borrarProducto(id) {
            if (!confirm("‚ö†Ô∏è ¬øEst√° seguro? Esta acci√≥n eliminar√° el producto de la base de datos definitivamente.")) return;
            
            const res = await fetch(API_URL, { 
                method: 'DELETE', 
                headers: { 'Authorization': adminPass, 'Content-Type': 'application/json' },
                body: JSON.stringify({ id }) 
            });

            if (res.status === 401) {
                alert("‚ùå Clave incorrecta. No tiene permisos.");
                logout();
            } else {
                cargarInventario();
            }
        }

        // --- PREPARAR ACTUALIZACI√ìN (UPDATE) ---
        function iniciarEdicion(id, nombre, marca, precio, stock) {
            isEditing = true;
            document.getElementById('prod-id').value = id;
            document.getElementById('nombre').value = nombre;
            document.getElementById('marca').value = marca;
            document.getElementById('precio').value = precio;
            document.getElementById('stock').value = stock;
            
            // UI Cambios
            document.getElementById('group-foto').style.display = 'none'; // No editamos foto por simplicidad
            document.getElementById('form-title').innerText = "Modificar Art√≠culo";
            document.getElementById('form-desc').innerText = "Actualiza los datos del producto seleccionado.";
            document.getElementById('btn-submit').innerText = "Guardar Cambios";
            document.getElementById('btn-cancel').style.display = 'block';
            
            // Switch de secci√≥n
            const btnAdd = document.querySelectorAll('.nav-btn')[1];
            showSection('sec-add', btnAdd);
        }

        function cancelarEdicion() {
            isEditing = false;
            document.getElementById('main-form').reset();
            document.getElementById('group-foto').style.display = 'block';
            document.getElementById('form-title').innerText = "A√±adir Nuevo Art√≠culo";
            document.getElementById('btn-submit').innerText = "Publicar en Tienda";
            document.getElementById('btn-cancel').style.display = 'none';
        }

        // --- CREAR Y ACTUALIZAR (POST / PUT) ---
        document.getElementById('main-form').onsubmit = async (e) => {
            e.preventDefault();
            const msg = document.getElementById('status-msg');
            const btn = document.getElementById('btn-submit');
            
            msg.style.display = "block";
            msg.style.backgroundColor = "#e3f2fd";
            msg.style.color = "#1976d2";
            msg.innerText = "‚è≥ Procesando solicitud...";
            btn.disabled = true;

            const datosBase = {
                nombre: document.getElementById('nombre').value,
                marca: document.getElementById('marca').value,
                precio: parseFloat(document.getElementById('precio').value),
                stock: parseInt(document.getElementById('stock').value)
            };

            try {
                if (isEditing) {
                    // MODO EDITAR (PUT)
                    const id = document.getElementById('prod-id').value;
                    const response = await fetch(API_URL, { 
                        method: 'PUT', 
                        headers: { 'Content-Type': 'application/json', 'Authorization': adminPass },
                        body: JSON.stringify({ id, ...datosBase }) 
                    });

                    if (response.status === 401) throw new Error("No autorizado");
                    alert("‚úÖ Producto actualizado correctamente.");
                    location.reload();

                } else {
                    // MODO AGREGAR (POST)
                    const fileInput = document.getElementById('fotoInput');
                    if (fileInput.files.length === 0) throw new Error("Debe seleccionar una foto para el nuevo producto.");

                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const fullData = { 
                            ...datosBase, 
                            categoria: document.getElementById('categoria').value,
                            imagenNombre: file.name.replace(/\s+/g, '-').toLowerCase(),
                            imagenBase64: reader.result.split(',')[1]
                        };

                        const response = await fetch(API_URL, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json', 'Authorization': adminPass },
                            body: JSON.stringify(fullData) 
                        });

                        if (response.status === 401) throw new Error("No autorizado");
                        alert("‚úÖ Nuevo producto publicado con √©xito.");
                        location.reload();
                    };
                }
            } catch (err) {
                msg.style.backgroundColor = "#ffebee";
                msg.style.color = "#c62828";
                msg.innerText = "‚ùå Error: " + err.message;
                btn.disabled = false;
                if(err.message === "No autorizado") logout();
            }
        };

        // Inicio
        checkAuth();
    </script>
</body>
</html>
